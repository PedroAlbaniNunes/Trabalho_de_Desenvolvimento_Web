<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brio - Todas as Receitas</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>

<body class="d-flex flex-column min-vh-100 bg-light">
  
  <!-- Filtros e Busca -->
  <section class="container py-4">
    <div class="row">
      <div class="col-12">
        <h1 class="text-brio-green mb-4">Todas as Receitas</h1>
        
        <!-- Barra de Busca e Filtros -->
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <div class="input-group">
              <input type="text" id="busca" class="form-control" placeholder="Buscar receitas...">
              <button class="btn btn-outline-secondary" type="button" onclick="buscarReceitas()">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <select id="categoria" class="form-select" onchange="buscarReceitas()">
              <option value="">Todas as categorias</option>
              <option value="Massa">Massa</option>
              <option value="Sobremesa">Sobremesa</option>
              <option value="Sanduíches">Sanduíches</option>
              <option value="Lanche">Lanche</option>
              <option value="Vegetariana">Vegetariana</option>
              <option value="Air Fryer">Air Fryer</option>
              <option value="Snacks">Snacks</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" onclick="limparFiltros()">
              <i class="fas fa-times"></i> Limpar
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Lista de Receitas -->
  <section class="container mb-5">
    <div id="loading" class="text-center py-5" style="display: none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
    </div>
    
    <div id="receitas-container" class="row g-4">
      <!-- Receitas serão carregadas aqui via JavaScript -->
    </div>
    
    <!-- Paginação -->
    <nav aria-label="Paginação de receitas" class="mt-5">
      <ul id="pagination" class="pagination justify-content-center">
        <!-- Paginação será gerada via JavaScript -->
      </ul>
    </nav>
  </section>

  <script src="components.js"></script>
  <script>
    carregarHeader("Brio - Receitas");
    carregarFooter();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let currentPage = 1;
    
    // Carregar receitas ao inicializar a página
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se há parâmetros na URL
      const urlParams = new URLSearchParams(window.location.search);
      const categoria = urlParams.get('categoria');
      const busca = urlParams.get('busca');
      
      if (categoria) {
        document.getElementById('categoria').value = categoria;
      }
      if (busca) {
        document.getElementById('busca').value = busca;
      }
      
      buscarReceitas();
    });
    
    function buscarReceitas(page = 1) {
      currentPage = page;
      const busca = document.getElementById('busca').value;
      const categoria = document.getElementById('categoria').value;
      
      // Mostrar loading
      document.getElementById('loading').style.display = 'block';
      document.getElementById('receitas-container').style.display = 'none';
      
      // Construir URL com parâmetros
      const params = new URLSearchParams({
        ajax: '1',
        page: page
      });
      
      if (busca) params.append('busca', busca);
      if (categoria) params.append('categoria', categoria);
      
      fetch(`../../src/backend/listarReceitas.php?${params}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            throw new Error(data.error);
          }
          
          renderReceitas(data.receitas);
          renderPaginacao(data.pagination);
          
          // Esconder loading
          document.getElementById('loading').style.display = 'none';
          document.getElementById('receitas-container').style.display = 'flex';
        })
        .catch(error => {
          console.error('Erro ao carregar receitas:', error);
          document.getElementById('receitas-container').innerHTML = 
            '<div class="col-12 text-center"><p class="text-danger">Erro ao carregar receitas. Tente novamente.</p></div>';
          document.getElementById('loading').style.display = 'none';
          document.getElementById('receitas-container').style.display = 'flex';
        });
    }
    
    function renderReceitas(receitas) {
      const container = document.getElementById('receitas-container');
      
      if (receitas.length === 0) {
        container.innerHTML = '<div class="col-12 text-center"><p class="text-muted">Nenhuma receita encontrada.</p></div>';
        return;
      }
      
      container.innerHTML = receitas.map(receita => `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <h5 class="card-title text-brio-green">${receita.nome}</h5>
              <p class="card-text text-muted small">Por: ${receita.autor_nome}</p>
              <p class="card-text">${receita.descricao.substring(0, 100)}${receita.descricao.length > 100 ? '...' : ''}</p>
              
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-secondary">${receita.categoria}</span>
                <small class="text-muted">
                  <i class="fas fa-clock"></i> ${receita.tempo_preparo_minutos} min
                </small>
              </div>
              
              <div class="d-flex justify-content-between align-items-center">
                <span class="badge bg-info">Nível ${receita.dificuldade}</span>
                <div>
                  <button class="btn btn-sm btn-outline-danger me-2" onclick="toggleFavorito(${receita.id}, this)">
                    <i class="fas fa-heart"></i>
                  </button>
                  <a href="receita.html?id=${receita.id}" class="btn btn-sm texto_botao">Ver Receita</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    function renderPaginacao(pagination) {
      const container = document.getElementById('pagination');
      
      if (pagination.total_pages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // Botão anterior
      if (pagination.has_prev) {
        html += `<li class="page-item">
          <a class="page-link" href="#" onclick="buscarReceitas(${pagination.current_page - 1})">Anterior</a>
        </li>`;
      }
      
      // Números das páginas
      for (let i = 1; i <= pagination.total_pages; i++) {
        if (i === pagination.current_page) {
          html += `<li class="page-item active">
            <span class="page-link">${i}</span>
          </li>`;
        } else {
          html += `<li class="page-item">
            <a class="page-link" href="#" onclick="buscarReceitas(${i})">${i}</a>
          </li>`;
        }
      }
      
      // Botão próximo
      if (pagination.has_next) {
        html += `<li class="page-item">
          <a class="page-link" href="#" onclick="buscarReceitas(${pagination.current_page + 1})">Próximo</a>
        </li>`;
      }
      
      container.innerHTML = html;
    }
    
    function limparFiltros() {
      document.getElementById('busca').value = '';
      document.getElementById('categoria').value = '';
      buscarReceitas(1);
    }
    
    function toggleFavorito(receitaId, button) {
      fetch('../../src/backend/favoritos.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `receita_id=${receitaId}&action=toggle`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const icon = button.querySelector('i');
          if (data.is_favorito) {
            button.classList.remove('btn-outline-danger');
            button.classList.add('btn-danger');
            icon.classList.add('fas');
            icon.classList.remove('far');
          } else {
            button.classList.remove('btn-danger');
            button.classList.add('btn-outline-danger');
            icon.classList.remove('fas');
            icon.classList.add('far');
          }
        } else {
          alert(data.error || 'Erro ao atualizar favoritos');
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atualizar favoritos');
      });
    }
    
    // Busca ao pressionar Enter
    document.getElementById('busca').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        buscarReceitas(1);
      }
    });
  </script>
</body>
</html>